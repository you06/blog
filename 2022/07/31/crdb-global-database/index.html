<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono&display=swap" rel="stylesheet">
<link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="icon" type="image/png" href="/icon/icon-196x196.png" sizes="196x196">
<link rel="icon" type="image/png" href="/icon/icon-96x96.png" sizes="96x96">
<meta name="description" content="CRDB åœ¨ SIGMOD 2022 ä¸Šå‘è¡¨äº†ä¸€ç¯‡å…³äºä»–ä»¬å¦‚ä½•åš multi-region DB çš„è®ºæ–‡ã€ŒEnabling the Next Generation of Multi-Region Applications with CockroachDBã€ï¼Œä¸ºè¿™ä¸ªé¢˜ç›®äº¤ä¸Šäº†ä¸€ä»½ç›¸å¯¹å®Œæ•´çš„ç­”æ¡ˆã€‚ Multi-Region çš„éœ€æ±‚æ¥æºäºé«˜å¯ç”¨å’Œæ”¿ç­–è¦æ±‚ï¼ˆä¾‹å¦‚ GDPRï¼‰ã€‚ä¸ºæ­¤ï¼ŒCRDB å¼•å…¥äº†ä¸€äº›åŸºç¡€">
<meta property="og:type" content="article">
<meta property="og:title" content="CRDB Global Database">
<meta property="og:url" content="https://blog.tongmu.me/2022/07/31/crdb-global-database/index.html">
<meta property="og:site_name" content="Freezing">
<meta property="og:description" content="CRDB åœ¨ SIGMOD 2022 ä¸Šå‘è¡¨äº†ä¸€ç¯‡å…³äºä»–ä»¬å¦‚ä½•åš multi-region DB çš„è®ºæ–‡ã€ŒEnabling the Next Generation of Multi-Region Applications with CockroachDBã€ï¼Œä¸ºè¿™ä¸ªé¢˜ç›®äº¤ä¸Šäº†ä¸€ä»½ç›¸å¯¹å®Œæ•´çš„ç­”æ¡ˆã€‚ Multi-Region çš„éœ€æ±‚æ¥æºäºé«˜å¯ç”¨å’Œæ”¿ç­–è¦æ±‚ï¼ˆä¾‹å¦‚ GDPRï¼‰ã€‚ä¸ºæ­¤ï¼ŒCRDB å¼•å…¥äº†ä¸€äº›åŸºç¡€">
<meta property="og:locale">
<meta property="og:image" content="https://blog.tongmu.me/2022/07/31/crdb-global-database/global-txn-wait.png">
<meta property="article:published_time" content="2022-07-31T18:08:34.000Z">
<meta property="article:modified_time" content="2024-02-14T15:21:24.384Z">
<meta property="article:author" content="you06">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.tongmu.me/2022/07/31/crdb-global-database/global-txn-wait.png">
<meta name="twitter:creator" content="@you06v">
<meta name="twitter:title" content="CRDB Global Database">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BCL84R82GK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-BCL84R82GK');
</script>


<meta name="twitter:description" content="CRDB åœ¨ SIGMOD 2022 ä¸Šå‘è¡¨äº†ä¸€ç¯‡å…³äºä»–ä»¬å¦‚ä½•åš multi-region DB çš„è®ºæ–‡ã€ŒEnabling the Next Generation of Multi-Region Applications with CockroachDBã€ï¼Œä¸ºè¿™ä¸ªé¢˜ç›®äº¤ä¸Šäº†ä¸€ä»½ç›¸å¯¹å®Œæ•´çš„ç­”æ¡ˆã€‚ Multi-Region çš„éœ€æ±‚æ¥æºäºé«˜å¯ç”¨å’Œæ”¿ç­–è¦æ±‚ï¼ˆä¾‹å¦‚ GDPRï¼‰ã€‚ä¸ºæ­¤ï¼ŒCRDB å¼•å…¥äº†ä¸€äº›åŸºç¡€">


<title>CRDB Global Database | Freezing</title>


<link rel="stylesheet" href="/styles/main.css">


    <!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Freezing" type="application/atom+xml">
<link rel="alternate" href="/rss2.xml" title="Freezing" type="application/rss+xml">
</head>
    <body>
        <div class="container">
            <header>
<div id='wx_pic' style='margin:0 auto;display:none;'>
    <img src='/icon/wechat-icon.jpg' />
</div>
<div class="main">
<div class="title">
    <a href="/" class="logo">Freezing</a>
</div>
<div class="site-nav">
    <ul id="menu" class="menu">
    
        <li class="menu-item text-underline">
            <a href="/">Home</a>
        </li>
    
        <li class="menu-item text-underline">
            <a href="/archives">Archives</a>
        </li>
    
        <li class="menu-item text-underline">
            <a href="/about/">About</a>
        </li>
            
    </ul>
</div>
</div>
</header>
            <main class="main">
                <section class="posts clearfix">
<div class="post-wrapper">
    <article class="post article-entry">
    <div class="post-title">
        CRDB Global Database
    </div>
    <p class="sub">Jul 31 2022</p>
    <div class="post-content">
        <p>CRDB åœ¨ SIGMOD 2022 ä¸Šå‘è¡¨äº†ä¸€ç¯‡å…³äºä»–ä»¬å¦‚ä½•åš multi-region DB çš„è®ºæ–‡ã€ŒEnabling the Next Generation of Multi-Region Applications with CockroachDBã€ï¼Œä¸ºè¿™ä¸ªé¢˜ç›®äº¤ä¸Šäº†ä¸€ä»½ç›¸å¯¹å®Œæ•´çš„ç­”æ¡ˆã€‚</p>
<p>Multi-Region çš„éœ€æ±‚æ¥æºäºé«˜å¯ç”¨å’Œæ”¿ç­–è¦æ±‚ï¼ˆä¾‹å¦‚ GDPRï¼‰ã€‚ä¸ºæ­¤ï¼ŒCRDB å¼•å…¥äº†ä¸€äº›åŸºç¡€æ¦‚å¿µï¼š</p>
<ul>
<li>Regionï¼Œåœ°ç†ä¸Šçš„åŒºåŸŸ<ul>
<li>Zoneï¼ŒRegion ä¸‹é¢çš„å¯ç”¨åŒº</li>
</ul>
</li>
<li>Table localityï¼Œæ˜¯å¦ä¸ºæœ¬åœ°è¡¨ï¼Œæœ¬åœ°è¡¨æŒ‡ä¸»è¦çš„è®¿é—®éƒ½æ¥è‡ªäºä¸€ä¸ª region å†…</li>
<li>Survivability goalï¼Œä¿æŒæœåŠ¡å¯ç”¨çš„æƒ…å†µä¸‹èƒ½å¤Ÿå®¹å¿çš„é”™è¯¯ï¼ˆzone failure or region failureï¼‰</li>
</ul>
<p>è¿™äº›æ¦‚å¿µéƒ½èƒ½å¤Ÿç”¨ SQL è¿›è¡Œè¡¨è¾¾ï¼Œå¹¶ä¸”èƒ½å¤Ÿä¸ DDL è¯­å¥æ— ç¼ç»“åˆã€‚åŒæ—¶ CRDB ä¹Ÿæœ‰é’ˆå¯¹ä¸åŒæ¡ä»¶çš„ä¼˜åŒ–ï¼Œä¾‹å¦‚æœ¬åœ°è¡¨çš„å…¨å±€å”¯ä¸€æ€§æ£€æµ‹ä¸éœ€è¦è®¿é—®è¿œç¨‹èŠ‚ç‚¹ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦åšçš„å·¥ä½œæ˜¯ï¼š</p>
<ul>
<li>é€šè¿‡å°†ä¸Šè¿°ä¸‰ä¸ªæ¦‚å¿µç»“åˆåˆ° SQL ä¸­ï¼Œæå¤§ç®€åŒ– multi-region çš„é…ç½®</li>
<li>ä¼˜åŒ–å™¨æ”¯æŒ geo-partition</li>
<li>åªè¯»äº‹åŠ¡çš„ serializability</li>
<li>å• key äº‹åŠ¡çš„ strict serializability</li>
</ul>
<h2 id="æŠ½è±¡ä¸-SQL"><a href="#æŠ½è±¡ä¸-SQL" class="headerlink" title="æŠ½è±¡ä¸ SQL"></a>æŠ½è±¡ä¸ SQL</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cockroach start \</span><br><span class="line">	--locality=region=us-east-1,zone=us-east-1b <span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p>CRDB åœ¨å‘½ä»¤è¡Œä¹‹ä¸­æŒ‡å®š region å’Œ zoneï¼Œæœ€åæ•´ä¸ªé›†ç¾¤çš„ region/zone æ˜¯æ‰€æœ‰ node region/zone çš„æ€»å’Œï¼Œå¯ä»¥é€šè¿‡ <code>SHOW REGIONS</code> æŸ¥çœ‹ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE movr <span class="keyword">PRIMARY</span> REGION &quot;us-east1&quot; REGIONS &quot;us-west1&quot;, &quot;europe-west1&quot;;</span><br><span class="line"><span class="keyword">ALTER</span> DATABASE movr <span class="keyword">ADD</span> REGION &quot;australia-southeast1&quot;;</span><br><span class="line"><span class="keyword">ALTER</span> DATABASE movr <span class="keyword">DROP</span> REGION &quot;us-west1&quot;;</span><br></pre></td></tr></table></figure>

<p>CRDB é€šè¿‡ SQL æ‰§è¡Œ database æ‰€å±çš„ region</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> DATABASE movr SURVIVE REGION FAILURE;</span><br><span class="line"><span class="keyword">ALTER</span> DATABASE movr SURVIVE ZONE FAILURE;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æŒ‡å®šå¯ç”¨æ€§çš„ç›®æ ‡ï¼ŒCRDB èƒ½å¤Ÿæ›´åŠ çµæ´»çš„è°ƒåº¦å‰¯æœ¬ï¼Œåœ¨å¯ç”¨æ€§ç›®æ ‡çš„å®¹å¿èŒƒå›´å†…ï¼Œå½“é‡åˆ° region/zone failure æ—¶å€™ï¼Œå†™å…¥è¯·æ±‚æœ€å¤šå¢åŠ ä¸€ä¸ªç¦»æœ€è¿‘ region çš„ RTTï¼Œè¯»è¯·æ±‚åˆ™ä¸å—å½±å“ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> west_coast_users ( ... ) LOCALITY REGIONAL <span class="keyword">BY</span> <span class="keyword">TABLE</span></span><br><span class="line">	<span class="keyword">IN</span> &quot;us-west1&quot;;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> users ( ... ) LOCALITY REGIONAL <span class="keyword">BY</span> <span class="type">ROW</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> promo_codes <span class="keyword">SET</span> LOCALITY <span class="keyword">GLOBAL</span>;</span><br></pre></td></tr></table></figure>

<p>å»ºè¡¨è¯­å¥èƒ½å¤ŸæŒ‡å®šè¡¨çš„ localityï¼Œ<code>BY TABLE/ROW</code> çš„è¡¨ä¼šä¼˜åŒ–é‚£ä¸€å¼ è¡¨/è¡Œåœ¨æŒ‡å®š region ä¸‹çš„è¯»å†™æ€§èƒ½ï¼Œ<code>GLOBAL</code> åˆ™ä¼šä¼˜åŒ–å…¨å±€çš„è¯»æ€§èƒ½ï¼Œç‰ºç‰²å†™æ€§èƒ½ã€‚</p>
<p><strong>è‡ªåŠ¨åˆ†åŒº</strong>ä¼š row æ”¾åœ¨å®ƒè¢« insert çš„åˆ†åŒºä¸­ï¼Œ<strong>è‡ªåŠ¨è¿ç§»ï¼ˆ<code>ON UPDATE rehome_row()</code>ï¼‰</strong>ä¼šå°† row æ”¾åˆ°å®ƒæœ€è¿‘è¢« update çš„åˆ†åŒºä¸­ï¼Œä¸ºäº†é˜²æ­¢æŠ–åŠ¨ï¼Œé»˜è®¤ä¸æ‰“å¼€è‡ªåŠ¨åˆ†åŒºã€‚</p>
<p>å¯¹äºé‚£äº›å·²ç»æ”¯æŒåˆ†åŒºçš„åº”ç”¨ï¼Œä»–ä»¬æˆ–è®¸ä¸æ„¿æ„åœ¨ insert è¯­å¥ä¸­é¢å¤–æŒ‡å®šåˆ†åŒºï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ <code>REGIONAL BY ROW</code> DDL è¯­å¥ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crdb_region crdb_internal_region <span class="keyword">AS</span> (<span class="keyword">CASE</span> <span class="keyword">WHEN</span> state <span class="operator">=</span> <span class="string">&#x27;CA&#x27;</span></span><br><span class="line">	<span class="keyword">THEN</span> <span class="string">&#x27;us-west1&#x27;</span> <span class="keyword">ELSE</span> <span class="string">&#x27;us-east1&#x27;</span> <span class="keyword">END</span>) STORED</span><br></pre></td></tr></table></figure>

<p>å¯¹äº <code>REGIONAL BY ROW</code> çš„è¡¨ï¼Œå¯ä»¥å°† <code>crdb_region</code> å®šä¹‰ä¸ºä¸€ä¸ªè®¡ç®—åˆ—ï¼Œå½“æ¡ä»¶ä¸­æœ‰ <code>state</code> æ—¶ï¼Œå°±ä¼šæŒ‰ç…§è¿™ä¸ªè§„åˆ™å»åš local æŸ¥è¯¢ã€‚</p>
<h2 id="Placement"><a href="#Placement" class="headerlink" title="Placement"></a>Placement</h2><p>CRDB ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://www.notion.so/Enabling-the-Next-Generation-of-Multi-Region-Applications-with-CockroachDB-990d2a5971b1480ab89b0715d2bf4326">zone configurations</a> æ¥é…ç½® placementï¼ŒCRDB åœ¨ v21.1 æ”¯æŒäº† non-voting replicasï¼Œä¹Ÿå« read-only replicasï¼Œå› æ­¤å°±æœ‰äº†è¿™ä¹ˆä¸€å †çœ‹èµ·æ¥å¾ˆç¹ççš„é…ç½®ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// The difference between num_replicas and num_voters</span><br><span class="line">// determines the number of non-voting replicas.</span><br><span class="line">num_voters = &lt;int&gt;</span><br><span class="line">num_replicas = &lt;int&gt;</span><br><span class="line"></span><br><span class="line">// constraints applies to both voting and non-voting</span><br><span class="line">// replicas. It fixes a replica count per-region,</span><br><span class="line">// allowing the remainder to be placed freely.</span><br><span class="line">// voter_constraints is similar but for voters only.</span><br><span class="line">constraints = &#123;</span><br><span class="line">	+region=&lt;string&gt;: &lt;int&gt;,</span><br><span class="line">	+region=&lt;string&gt;: &lt;int&gt;,</span><br><span class="line">	+region=&lt;string&gt;: &lt;int&gt;,</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line">voter_constraints = &#123;+region=&lt;string&gt;: &lt;int&gt;, ... &#125;</span><br><span class="line"></span><br><span class="line">// lease_preferences pins the leaseholder to a specific</span><br><span class="line">// region, allowing for consistent reads from within.</span><br><span class="line">lease_preferences = [[+region=&lt;string&gt;]]</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯è¿™äº›ç¹ççš„é…ç½®ç›¸æ¯”äºå¦‚ â€œæˆ‘è¦æ±‚ region failure æ—¶æœåŠ¡ä¸ä¸­æ–­â€ çš„å£å¤´è¯­è¿˜æ˜¯æ¥çš„æ›´å¥½ç”¨ã€‚ä¸Šä¸€èŠ‚æ‰€è¯´çš„ locality é…ç½®ï¼ˆ<code>REGION BY TABLE/ROW</code> ï¼‰å°±æ˜¯é€šè¿‡ zone configurations æ¥å®ç°çš„ã€‚</p>
<ul>
<li>Home regionï¼Œä¸»è¦å‘ç”Ÿè¯»å†™çš„ region</li>
<li>Zone survivabilityï¼Œåœ¨ zone failure çš„ survivability è¦æ±‚ä¸‹ï¼Œ3 ä¸ª voting replicas éƒ½ä¼šè¢«åˆ†é…åœ¨ home region ä¸­ï¼ˆä¸åŒçš„ zone é‡Œï¼‰ï¼Œnon-home region é‡Œä¼šæœ‰ non-voting replicas æ¥åŠ é€Ÿè¯»</li>
<li>Region survivabilityï¼Œregion survivability éœ€è¦å®¹å¿ region failureï¼Œå› æ­¤è¦æ±‚è‡³å°‘æœ‰ 3 ä¸ªå¯ç”¨ regionï¼Œåœ¨ home region ä¸­æœ‰ 2 ä¸ªå‰¯æœ¬èƒ½å¤Ÿæˆä¸º candidatesï¼Œå› æ­¤ N region çš„é›†ç¾¤ä¸­ä¼šæœ‰ $ğ‘šğ‘ğ‘¥ (2 + (ğ‘ âˆ’ 1), ğ‘›ğ‘¢ğ‘š_ğ‘£ğ‘œğ‘¡ğ‘’ğ‘Ÿğ‘ )$ ä¸ªå‰¯æœ¬</li>
<li>Placement Restrictedï¼Œæœ€åï¼Œå› ä¸ºä¸€äº›åˆè§„çš„è¦æ±‚ï¼ˆå¦‚ GDPRï¼‰ï¼Œæœ‰äº›æ•°æ®ä¸èƒ½å¤Ÿå‡º regionï¼Œå› æ­¤ zone survivability çš„æ•°æ®åº“èƒ½å¤ŸåŠ ä¸Š placement restricted çº¦æŸï¼Œè¿™æ ·æ‰€æœ‰çš„ replica éƒ½ä¼šç¡®ä¿åœ¨ home reigon å†…ï¼ˆä½†æ˜¯å’ŒåŸæœ¬çš„ zone survivability æœ‰ä½•åŒºåˆ«ï¼Ÿï¼‰ã€‚Placement restricted å¯¹ global table æ²¡æœ‰æ•ˆæœï¼Œå¹¶ä¸”ä¸èƒ½å’Œ region survivability åŒæ—¶é…ç½®</li>
</ul>
<h2 id="è€ƒè™‘-locality-çš„ä¼˜åŒ–å™¨"><a href="#è€ƒè™‘-locality-çš„ä¼˜åŒ–å™¨" class="headerlink" title="è€ƒè™‘ locality çš„ä¼˜åŒ–å™¨"></a>è€ƒè™‘ locality çš„ä¼˜åŒ–å™¨</h2><h3 id="Unique-Constraint"><a href="#Unique-Constraint" class="headerlink" title="Unique Constraint"></a>Unique Constraint</h3><p>CRDB çš„ <code>REGIONAL BY ROW</code> è¡¨èƒ½å¤Ÿä¸ä½¿ç”¨æ˜¾ç¤ºçš„åˆ†åŒº columnï¼ˆä¹Ÿæ²¡æœ‰ç”¨éšè—åˆ—ï¼‰ï¼Œä¸ºäº†ä¿è¯å…¨å±€çš„å”¯ä¸€æ€§ï¼ŒCRDB ä¸ºæ¯ä¸ª insert/update è¯­å¥å¹¶è¡Œçš„åœ¨æ¯ä¸ªåˆ†åŒºåšå”¯ä¸€æ€§æ£€æµ‹ï¼Œè¿™é‡Œæœ‰ corss-region latencyï¼Œè€Œä¸ºäº†å°½å¯èƒ½é™ä½è¿™ç§è¯·æ±‚å¸¦æ¥çš„å»¶è¿Ÿï¼ŒCRDB åœ¨æŸäº›æƒ…å†µä¸‹ä¼šè·³è¿‡å”¯ä¸€æ€§æ£€æµ‹ï¼ˆé»˜è®¤æ–°æ•°æ®ä¹Ÿæ˜¯å”¯ä¸€çš„ï¼‰ï¼š</p>
<ul>
<li>UUID åˆ—ï¼Œå› ä¸ºç¢°æ’ç‡éå¸¸ä½ï¼Œé»˜è®¤ä¸æ£€æŸ¥</li>
<li>ç´¢å¼•å®šä¹‰ä¸Šæœ‰ <code>crdb_region</code> æ ‡è®°ï¼Œå¦‚ <code>UNIQUE (crdb_region, col)</code></li>
<li>å°† crdb_region å®šä¹‰ä¸ºä¸€ä¸ª unique column çš„ç”Ÿæˆåˆ—ï¼Œæ­¤æ—¶ partition çš„å”¯ä¸€æ€§èƒ½å¤Ÿæ¨æ–­ global çš„å”¯ä¸€æ€§</li>
</ul>
<h3 id="Locality-Optimized-Search-LOS"><a href="#Locality-Optimized-Search-LOS" class="headerlink" title="Locality Optimized Search (LOS)"></a>Locality Optimized Search (LOS)</h3><p>å½“ä½¿ç”¨ä¸€ä¸ªå”¯ä¸€ç´¢å¼•ä½œä¸ºæŸ¥è¯¢æ¡ä»¶æ—¶ï¼Œè‡³å¤šèƒ½æ‰¾åˆ°ä¸€æ¡æ•°æ®ï¼ŒCRDB ä¼šå…ˆåœ¨æœ¬åœ°æŸ¥è¯¢æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œåªæœ‰å½“æœ¬åœ°ä¸å­˜åœ¨æ—¶ï¼Œæ‰å»å…¶ä»– partition æŸ¥æ‰¾ã€‚å°†è¿™ä¸ªæ€è·¯æ‰©å±•ï¼Œä»»ä½•è¿”å›æœ‰é™è¡Œçš„æŸ¥è¯¢ï¼ˆä¾‹å¦‚ limit å’Œ where inï¼‰éƒ½èƒ½å¤Ÿä¼˜å…ˆåšæœ¬åœ°æŸ¥æ‰¾ï¼Œå†åšè¿œç¨‹æŸ¥æ‰¾ã€‚åŒç†ï¼Œåœ¨ join ä¸­ï¼Œæ ¹æ®å·¦è¡¨æŸ¥è¯¢å³è¡¨çš„å€¼æ—¶ï¼Œä¹Ÿèƒ½å¤Ÿä½¿ç”¨ LOS ä¼˜åŒ–ã€‚ï¼ˆä¸ªäººæ„è§ï¼ŒLOS æ˜¯ä¸€ç§ä¹è§‚ç­–ç•¥ï¼Œåº”è¯¥åœ¨æŸäº›æƒ…å†µä¸‹æœ‰å›é€€ï¼‰</p>
<h2 id="Stale-Read"><a href="#Stale-Read" class="headerlink" title="Stale Read"></a>Stale Read</h2><p>ä¸ºäº†åŠ é€ŸæŸ¥è¯¢ï¼ŒCRDB å¯¹è¯»å–æ—¶æ‰€ä½¿ç”¨çš„å‰¯æœ¬åšäº†ä¸‰ä¸ªä¼˜åŒ–ï¼š</p>
<ul>
<li>Follower Read</li>
<li>Non-voting replicas Read</li>
<li>Stale Read</li>
</ul>
<p>è¿™äº›éƒ½æ˜¯ä¸€äº›æ¯”è¾ƒå¸¸è§çš„ä¼˜åŒ–ï¼Œä¸»è¦å·¥ä½œæ˜¯ç¡®è®¤ Raft log çš„ committed index æ˜¯å¦å¤åˆè¯»çš„è¦æ±‚ï¼Œè¯´èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œä¸å±•å¼€è¯´äº†ï¼ˆæ‡’ï¼‰</p>
<h2 id="Global-Transaction"><a href="#Global-Transaction" class="headerlink" title="Global Transaction"></a>Global Transaction</h2><p>è¿™ç¯‡è®ºæ–‡ä¸­è¯´å®ƒæå‡ºäº† a novel global transaction protocolï¼ŒæŒ‡çš„å°±æ˜¯è¿™ä¸ª global transactionï¼Œæ‰€ä»¥é‡ç‚¹æ¥è®²è®²è¿™éƒ¨åˆ†ã€‚è¿™ä¸ª global transaction protocol æ˜¯ä¸ºä¸Šé¢æåˆ°çš„ global table å‡†å¤‡çš„ï¼Œå›é¡¾ä¸€ä¸‹ global table çš„è¦æ±‚ï¼š</p>
<ul>
<li>æ‰€æœ‰ region éƒ½èƒ½å¤Ÿ local read</li>
<li>å†™å…¥æ€§èƒ½ä¼šå—åˆ°å½±å“</li>
</ul>
<p>CRDB é‡‡ç”¨çš„æ–¹æ¡ˆå« â€œwrite into the futureâ€ï¼Œå†™å…¥ä¸€æ¡æœªæ¥ timestamp çš„æ•°æ®ï¼Œå¹¶ä¸” commit çº¿ç¨‹è¦ç­‰å¾…<strong>æœ¬åœ°çš„</strong> HLC æ—¶é’Ÿè¶…è¿‡è¿™ä¸ª future timestamp æ‰è¿”å›æˆåŠŸï¼Œåœ¨æ¬¡ä¹‹å‰éƒ½æ˜¯ uncertainty windowï¼Œä½†å®ƒåªå»¶è¿Ÿè¿”å›äº‹åŠ¡æˆåŠŸï¼Œ2PC çš„ lock ä¼šåœ¨ç¬¬ä¸€æ—¶é—´è¢«æ¸…ç†ä¸ä¼šè¢«æ¨è¿Ÿã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“åœ¨ä½¿ç”¨ HLC æ—¶ï¼Œå½“è¯»äº‹åŠ¡é‡åˆ° uncertainty window æ—¶ï¼Œéœ€è¦é‡å¯äº‹åŠ¡ç”¨æ›´æ–°çš„ timestamp æ¥æ¶ˆé™¤ uncertainty window å¸¦æ¥çš„ç ´å linearizability çš„é£é™©ï¼ˆuncertainty refreshï¼‰ï¼Œå›¾ step3 å°±éœ€è¦åš uncertainty refreshã€‚ä¸Šé¢æåˆ°äº†ï¼Œfuture write è¿”å›æˆåŠŸçš„æ¡ä»¶æ˜¯ <code>local HLC &gt; future timestamp</code>ï¼Œæ‰€ä»¥å¯èƒ½å­˜åœ¨æœ‰çš„èŠ‚ç‚¹çš„ HLC ä»ç„¶å°äº future timestamp çš„æƒ…å†µï¼Œé‚£ä¹ˆä»…ä»…é  uncertainty refresh æœºåˆ¶ï¼Œå°±å¯èƒ½äº§ç”Ÿâ€œæå‰è¯»åˆ°â€çš„é—®é¢˜ã€‚å‡å¦‚ w æ˜¯ä¸€ä¸ª future write äº‹åŠ¡ï¼Œr è¯»åˆ°äº† w çš„å†™å…¥ï¼Œéšåçš„ râ€™ æ²¡æœ‰è¯»åˆ° w çš„å†™å…¥ã€‚åœ¨çœŸå®æ—¶é—´ä¸Šï¼Œå‘ç”Ÿçš„é¡ºåºæ˜¯ r â†’ râ€™ï¼Œä½†æ˜¯ä»è¯»å–çš„ç»“æœæ¥çœ‹åˆ™æ˜¯ râ€™ â†’ w â†’ rï¼Œè¿™å°±è¿èƒŒäº† linearizabilityã€‚è¿™é‡Œä¼šè®©äººå›°æƒ‘ï¼Œéƒ½æœ‰ uncertainty refresh æœºåˆ¶çš„ä¿è¯äº†ï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šæå‰è¯»åˆ°å‘¢ï¼Ÿå› ä¸º uncertain window æ˜¯ HLC çš„ç‰©ç†æ—¶é—´åå·®çš„ä¸Šé™ï¼Œä½†æ˜¯ future timestamp å¹¶ä¸æ˜¯å–è‡ª HLC æ—¶é—´çš„ï¼Œå‡è®¾ä¸‹é¢è¿™ç§æƒ…å†µï¼ˆuncertain window å– 250msï¼‰ï¼š</p>
<ul>
<li>HLC(w) = 1000ms</li>
<li>HLC(r) = 1100ms</li>
<li>HLIC(râ€™) = 900ms</li>
<li>future timestamp = 1200ms</li>
</ul>
<p>å½“ HLC(r) è¿›è¡Œè¯»å–æ—¶ï¼Œå®ƒçš„ uncertain window æ˜¯ <code>[1100ms, 1350ms]</code>ï¼Œå½“é‡åˆ° future timestamp æ—¶ï¼Œå®ƒä¼šé‡å¯å¹¶ä¸”å°† uncertain window æ›´æ–°ä¸º <code>[1201ms, 1350ms]</code>ï¼Œå†æ¬¡è¯»å–æ—¶å³å¯è¯»åˆ°è¿™æ¡ future writeã€‚ä½†æ˜¯ï¼Œfuture timestamp è½åœ¨äº† HLC(râ€™) çš„ uncertain window ä¹‹å¤–ï¼Œå› æ­¤ râ€™ æ²¡æœ‰æœºä¼šå‘ç°åœ¨è‡ªå·±çš„uncertainty window é‡Œæœ‰ä¸€æ¡æ•°æ®ï¼Œä¹Ÿæ²¡æœ‰æœºä¼šåš uncertainty refreshã€‚è¿™é‡Œçš„å…³é”®ç‚¹åœ¨äºæ ¹æ® future timestamp æ¥æ¨ ts æ˜¯ä¸å®‰å…¨çš„ã€‚</p>
<p><img src="global-txn-wait.png" alt="global-txn-wait"></p>
<p>è§£å†³è¿™ä¸ªé—®é¢˜ä¹Ÿå¾ˆç®€å•ï¼Œå½“è¯»äº‹åŠ¡å‘ç°åœ¨è‡ªèº« uncertain window ä¹‹å¤–çš„ future timestamp æ—¶ï¼ˆå›¾ä¸­ step3ï¼Œå¦‚ä¸Šè¿° râ€™ï¼‰ï¼Œå¯ä»¥å¿½ç•¥è¿™æ¡ future writeï¼›ä½†æ˜¯å½“è¯»äº‹åŠ¡å‘ç°åœ¨è‡ªèº«çš„ uncertain window ä¹‹å†…çš„ future timestamp æ—¶ï¼ˆå›¾ä¸­ step4ï¼Œå¦‚ä¸Šè¿° rï¼‰ï¼Œåˆ™éœ€è¦ç­‰å¾…æœ¬åœ°çš„ HLC è¶…è¿‡ future timestmap æ—¶åœ¨è¿›è¡Œè¯»å–ï¼Œæ­¤æ—¶å³å¯ä¿è¯ râ€™ çš„ HLC çš„ uncertain window è‡³å°‘èƒ½å¤Ÿå‘ç°è¿™æ¡ future writeï¼Œé˜²æ­¢ linearizability è¢«ç ´åã€‚</p>
<h3 id="Local-Read"><a href="#Local-Read" class="headerlink" title="Local Read"></a>Local Read</h3><p>Global transaction çš„ä¸€ä¸ªè¦æ±‚æ˜¯æ‰€æœ‰çš„ region éƒ½èƒ½å¤Ÿè¿›è¡Œ local readï¼Œé‚£ä¹ˆè¿™é‡Œå°±éœ€è¦è€ƒè™‘å‰¯æœ¬è¯»çš„å…¼å®¹æ€§ï¼Œç”±äº Raft çš„é¡ºåºæ€§çº¦æŸï¼Œå‰¯æœ¬è¯»åªéœ€è¦ä¿è¯ closed timestamp è¢«æ­£å¸¸æ¨è¿›ï¼Œå°±èƒ½å¤Ÿä¸æ¼è¯»ã€‚å› æ­¤å…³é”®ç‚¹ä¸åœ¨äºç»™ future write è®¾ç½®å¤šé•¿çš„ commit waitï¼ˆå½“å‡ºç°ç³»ç»ŸæŠ–åŠ¨æ—¶ï¼Œwait æ€»æœ‰ä½äºç½‘ç»œå»¶è¿Ÿçš„æ—¶å€™ï¼‰ï¼Œè€Œåœ¨äºå‰¯æœ¬è¯»éœ€è¦ä» write quorum å¤„è·å–åˆ°æœ€æ–°çš„ closed timestampã€‚</p>
<h2 id="ä¸ªäººè¯„ä»·"><a href="#ä¸ªäººè¯„ä»·" class="headerlink" title="ä¸ªäººè¯„ä»·"></a>ä¸ªäººè¯„ä»·</h2><p>è¿™ç¯‡è®ºæ–‡ä»å·¥ç¨‹å­¦æœ¯ä¸¤æ–¹é¢æ‰‹æŠŠæ‰‹çš„æ•™äººåš global databaseï¼Œçœ‹å®Œä¹‹åæ„Ÿå¹ä»–ä»¬çš„æ ¼å±€çœŸæ˜¯å¤§å•Šã€‚ä¿—è¯è¯´â€œä¸€æµä¼ä¸šåšæ ‡å‡†â€ï¼Œå¦‚æœç›¯ç€ MySQL æºç å»é­”æ”¹ï¼Œå¤§æ¦‚è¿™è¾ˆå­ä¹Ÿèµ°ä¸åˆ°è¿™ä¸€æ­¥å§ã€‚</p>

    </div>
    </article>
</div>

    <div class="_toc">
        <strong class="toc-title">
        Contents
        </strong>
        <div class="toc-content">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E4%B8%8E-SQL"><span class="toc-text">æŠ½è±¡ä¸ SQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Placement"><span class="toc-text">Placement</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%80%83%E8%99%91-locality-%E7%9A%84%E4%BC%98%E5%8C%96%E5%99%A8"><span class="toc-text">è€ƒè™‘ locality çš„ä¼˜åŒ–å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Unique-Constraint"><span class="toc-text">Unique Constraint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Locality-Optimized-Search-LOS"><span class="toc-text">Locality Optimized Search (LOS)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Stale-Read"><span class="toc-text">Stale Read</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Global-Transaction"><span class="toc-text">Global Transaction</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Local-Read"><span class="toc-text">Local Read</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AA%E4%BA%BA%E8%AF%84%E4%BB%B7"><span class="toc-text">ä¸ªäººè¯„ä»·</span></a></li></ol>
        </div>
    </div>

</section>


    <nav class="post-nav">
        
            <div class="page-tags">
                
            </div>
        
    </nav>



    <nav class="paginator clearfix">
        
            <a class="prev" href="/2023/04/16/photography-2023-04-1/">
                <i class="iconfont icon-left"></i>
                <span class="prev-text">é£æ™¯æ‘„å½±-2023-04</span>
            </a>
        
        
            <a class="next" href="/2022/07/03/build-a-epyc-server/">
                
                <span class="prev-text">Epyc æœåŠ¡å™¨ä¹‹å‘</span>
                <i class="iconfont icon-right"></i>
            </a>
        
    </nav>


            </main>
            <div class="copyright">
  
  <div>
      <img src="/assets/by-nc.svg">
  </div="text">
  

  <div class="text">Powered By
    <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> | Theme <a target="_blank" rel="noopener" href="https://github.com/zjx137/hexo-theme-Tsu">Tsu</a> &copy 2020
  </div>
</div>

        </div>
    <div class="back-to-top" id="back-to-top">
            <i class="iconfont icon-up"></i>
    </div>
        
    </body>
    
<script src="/js/jquery-3.3.1.min.js"></script>

    
<script src="/js/back-to-top.js"></script>

    
<script src="/js/scroll.js"></script>

    <!-- MathJaxé…ç½®ï¼Œå¯é€šè¿‡å•ç¾å…ƒç¬¦å·ä¹¦å†™è¡Œå†…å…¬å¼ç­‰ -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": { 
        preferredFont: "TeX", 
        availableFonts: ["STIX","TeX"], 
        linebreaks: { automatic:true }, 
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) 
    },
    tex2jax: { 
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ], 
        processEscapes: true, 
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {  
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, 
        Macros: { href: "{}" } 
    },
    messageStyle: "none"
    }); 
</script>
<!-- ç»™MathJaxå…ƒç´ æ·»åŠ has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- é€šè¿‡è¿æ¥CDNåŠ è½½MathJaxçš„jsä»£ç  -->
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

    
        <script src='https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js'></script>
        <script>
            if (window.mermaid) {
                mermaid.initialize({theme: 'forest'});
            }
        </script>
    
</html>
